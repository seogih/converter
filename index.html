<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4CAF50">
  <title>Converter</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      touch-action: manipulation;
    }
    .app-container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      padding-bottom: 80px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 16px;
      background: #4CAF50;
      color: white;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .top-bar button {
      background: none;
      border: none;
      color: white;
      font-size: 14px;
      padding: 8px 12px;
      cursor: pointer;
      user-select: none;
    }
    .top-bar h1 {
      font-size: 18px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .output-section {
      padding: 16px;
    }
    .output-row {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 12px;
      align-items: center;
      margin-bottom: 2px;
      min-height: 50px;
    }
    .output-cell {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 2px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      min-height: 44px;
      overflow: hidden;
    }
    .output-cell input {
      border: none;
      outline: none;
      font-size: 18px;
      width: 100%;
      font-family: inherit;
    }
    .output-cell input::-webkit-inner-spin-button,
    .output-cell input::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .output-cell input[type=number] {
      -moz-appearance: textfield;
    }
    .output-value {
      font-size: 18px;
      font-weight: 500;
      flex: 1;
      word-break: break-all;
    }
    .output-unit {
      font-size: 14px;
      color: #666;
      white-space: nowrap;
    }
    .equals {
      font-size: 20px;
      color: #666;
    }
    .row-b .output-cell:first-child {
      background: #e8f5e9;
    }
    .button-grid {
      padding: 2px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .button-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .convert-btn {
      min-height: 44px;
      padding: 12px 8px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .convert-btn:active {
      background: #1976D2;
    }
    .convert-btn.active {
      background: #FF9800;
    }
    .settings-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 200;
      overflow-y: auto;
    }
    .settings-screen.active {
      display: block;
    }
    .settings-content {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
    }
    .settings-grid {
      margin: 20px 0;
    }
    .settings-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 8px;
    }
    .draggable-btn {
      min-height: 44px;
      padding: 12px 8px;
      background: #E3F2FD;
      color: #1976D2;
      border: 2px solid #2196F3;
      border-radius: 8px;
      font-size: 15px;
      cursor: move;
      user-select: none;
      touch-action: none;
      text-align: center;
    }
    .draggable-btn.dragging {
      opacity: 0.5;
    }
    .exchange-rate-section {
      margin: 20px 0;
    }
    .exchange-rate-input {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .rate-input-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .rate-input-row input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      min-width: 0;
    }
    .rate-input-row input[type="number"] {
      flex: 2;
    }
    .rate-input-row input[type="text"] {
      flex: 1;
      text-transform: uppercase;
    }
    .rate-input-row span {
      font-size: 16px;
      color: #666;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .fetch-rate-btn {
      width: 100%;
      padding: 12px 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }
    .fetch-rate-btn:active {
      background: #45a049;
    }
    .settings-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    .settings-actions button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
    }
    .save-btn {
      background: #4CAF50;
      color: white;
    }
    .cancel-btn {
      background: #f5f5f5;
      color: #333;
    }
    .default-btn {
      background: #FF9800;
      color: white;
    }
    .update-banner, .install-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px;
      background: #323232;
      color: white;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      z-index: 300;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
      max-width: 600px;
      margin: 0 auto;
    }
    .update-banner.show, .install-banner.show {
      display: flex;
    }
    .banner-message {
      flex: 1;
      font-size: 14px;
    }
    .banner-actions {
      display: flex;
      gap: 8px;
    }
    .banner-actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
    }
    .update-btn {
      background: #4CAF50;
      color: white;
    }
    .install-btn {
      background: #2196F3;
      color: white;
    }
    .dismiss-btn {
      background: transparent;
      color: #ccc;
      border: 1px solid #666 !important;
    }
    .version-info {
      margin: 20px 0;
      padding: 12px;
      background: #f0f0f0;
      border-radius: 8px;
      font-size: 12px;
      color: #666;
      text-align: center;
    }
    .online-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-left: 6px;
    }
    .online-indicator.online {
      background: #4CAF50;
    }
    .online-indicator.offline {
      background: #f44336;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="top-bar">
      <button id="clearBtn">Clear</button>
      <h1>
        Converter
        <span class="online-indicator" id="onlineIndicator"></span>
      </h1>
      <button id="settingsBtn">Settings</button>
    </div>

    <div class="output-section">
      <div class="output-row row-a">
        <div class="output-cell">
          <input type="text" id="mainInput" inputmode="decimal" placeholder="0">
          <span class="output-unit" id="inputUnit"></span>
        </div>
        <div class="equals">=</div>
        <div class="output-cell">
          <span class="output-value" id="outputA"></span>
          <span class="output-unit" id="outputUnitA"></span>
        </div>
      </div>

      <div class="output-row row-b">
        <div class="output-cell">
          <span class="output-value" id="inputB"></span>
          <span class="output-unit" id="inputUnitB"></span>
        </div>
        <div class="equals">=</div>
        <div class="output-cell">
          <span class="output-value" id="outputB"></span>
          <span class="output-unit" id="outputUnitB"></span>
        </div>
      </div>
    </div>

    <div class="button-grid" id="buttonGrid"></div>
  </div>

  <div class="settings-screen" id="settingsScreen">
    <div class="top-bar">
      <div></div>
      <h1>Converter Settings</h1>
      <div></div>
    </div>
    <div class="settings-content">
      <div class="settings-grid" id="settingsGrid"></div>
      
      <div class="exchange-rate-section">
        <div class="exchange-rate-input">
          <div class="rate-input-row">
            <input type="number" id="exchangeRateInput" placeholder="1400" step="0.01">
            <input type="text" id="currencyCode" placeholder="KRW" maxlength="3">
            <span>/USD</span>
          </div>
          <button class="fetch-rate-btn" id="fetchRateBtn">Current Rate</button>
        </div>
      </div>
      
      <div class="version-info" id="versionInfo">
        <div>Version: <span id="appVersion">1.0.4</span></div>
        <div id="lastUpdateCheck"></div>
      </div>
      <div class="settings-actions">
        <button class="cancel-btn" id="cancelBtn">Cancel</button>
        <button class="default-btn" id="defaultBtn">Default</button>
        <button class="save-btn" id="saveBtn">Save</button>
      </div>
    </div>
  </div>

  <div class="update-banner" id="updateBanner">
    <div class="banner-message">New version available!</div>
    <div class="banner-actions">
      <button class="dismiss-btn" id="dismissUpdate">Later</button>
      <button class="update-btn" id="updateNow">Update</button>
    </div>
  </div>

  <div class="install-banner" id="installBanner">
    <div class="banner-message">Add to home screen for faster access!</div>
    <div class="banner-actions">
      <button class="dismiss-btn" id="dismissInstall">Close</button>
      <button class="install-btn" id="installApp">Install</button>
    </div>
  </div>

  <script>
    const APP_VERSION = '1.0.5';
    const DEFAULT_ORDER = {
      row1: ['$/lb', 'lb.oz', 'lb', 'F'],
      row2: ['shoes', 'ft.in', 'ft', '$'],
      row3: ['mile', 'mpg', 'gallon', 'yard']
    };
    const DEFAULT_RATE = 1400;
    const DEFAULT_CURRENCY = 'KRW';

    let currentMode = null;
    let exchangeRate = DEFAULT_RATE;
    let currencyCode = DEFAULT_CURRENCY;
    let buttonOrder = {
      row1: ['$/lb', 'lb.oz', 'lb', 'F'],
      row2: ['shoes', 'ft.in', 'ft', '$'],
      row3: ['mile', 'mpg', 'gallon', 'yard']
    };
    let deferredPrompt;
    let isOnline = navigator.onLine;

    // Shoe size conversion table (based on attached PDF - accurate data)
    const SHOE_SIZES = {
      // Korea(mm) -> US size
      mmToUs: {
        145: { men: null, women: null, youth: 8.5 },
        150: { men: null, women: null, youth: 9 },
        155: { men: null, women: null, youth: 9.5 },
        160: { men: null, women: null, youth: 10 },
        165: { men: null, women: null, youth: 10.5 },
        170: { men: null, women: null, youth: 11 },
        175: { men: null, women: null, youth: 11.5 },
        180: { men: null, women: null, youth: 12 },
        185: { men: null, women: null, youth: 12.5 },
        190: { men: null, women: null, youth: 13 },
        195: { men: null, women: null, youth: 13.5 },
        200: { men: null, women: null, youth: 1 },
        205: { men: null, women: null, youth: 1.5 },
        210: { men: null, women: 4, youth: 2 },
        215: { men: null, women: 4.5, youth: 2.5 },
        220: { men: null, women: 5, youth: 3 },
        225: { men: null, women: 5.5, youth: 3.5 },
        230: { men: null, women: 6, youth: 4 },
        235: { men: null, women: 6.5, youth: 4.5 },
        240: { men: 6, women: 7, youth: 5 },
        245: { men: 6.5, women: 7.5, youth: 5.5 },
        250: { men: 7, women: 8, youth: 6 },
        255: { men: 7.5, women: 8.5, youth: 6.5 },
        260: { men: 8, women: 9, youth: 7 },
        265: { men: 8.5, women: 9.5, youth: 7.5 },
        270: { men: 9, women: 10, youth: 8 },
        275: { men: 9.5, women: 10.5, youth: 8.5 },
        280: { men: 10, women: 11, youth: 9 },
        285: { men: 10.5, women: 11.5, youth: 9.5 },
        290: { men: 11, women: 12, youth: 10 },
        295: { men: 11.5, women: 12.5, youth: null },
        300: { men: 12, women: 13, youth: null }
      },
      // Korea(mm) -> EU size
      mmToEu: {
        145: { men: null, women: null, kids: 25.5 },
        150: { men: null, women: null, kids: 26 },
        155: { men: null, women: null, kids: 26.5 },
        160: { men: null, women: null, kids: 27 },
        165: { men: null, women: null, kids: 27.5 },
        170: { men: null, women: null, kids: 28 },
        175: { men: null, women: null, kids: 28.5 },
        180: { men: null, women: null, kids: 29 },
        185: { men: null, women: null, kids: 30 },
        190: { men: null, women: null, kids: 31 },
        195: { men: null, women: null, kids: 31.5 },
        200: { men: null, women: null, kids: 32 },
        205: { men: null, women: null, kids: 33 },
        210: { men: null, women: 34, kids: 33.5 },
        215: { men: null, women: 34.5, kids: 34 },
        220: { men: null, women: 35, kids: 35 },
        225: { men: null, women: 35.5, kids: 35.5 },
        230: { men: null, women: 36, kids: 36 },
        235: { men: null, women: 36.5, kids: 36.5 },
        240: { men: 39, women: 37, kids: 37 },
        245: { men: 39.5, women: 37.5, kids: 38 },
        250: { men: 40, women: 38, kids: 38.5 },
        255: { men: 40.5, women: 38.5, kids: 39 },
        260: { men: 41, women: 39, kids: null },
        265: { men: 41.5, women: 39.5, kids: null },
        270: { men: 42, women: 40, kids: null },
        275: { men: 42.5, women: 40.5, kids: null },
        280: { men: 43, women: 41, kids: null },
        285: { men: 43.5, women: 41.5, kids: null },
        290: { men: 44, women: 42, kids: null },
        295: { men: 44.5, women: 42.5, kids: null },
        300: { men: 45, women: 43, kids: null }
      }
    };

    // Helper functions for reverse conversion
    function findMmFromUsSize(size, type) {
      for (let [mm, sizes] of Object.entries(SHOE_SIZES.mmToUs)) {
        if (sizes[type] === size) return parseInt(mm);
      }
      return null;
    }

    function findMmFromEuSize(size, type) {
      for (let [mm, sizes] of Object.entries(SHOE_SIZES.mmToEu)) {
        if (sizes[type] === size) return parseInt(mm);
      }
      return null;
    }

    function updateOnlineStatus() {
      const indicator = document.getElementById('onlineIndicator');
      isOnline = navigator.onLine;
      indicator.className = `online-indicator ${isOnline ? 'online' : 'offline'}`;
      indicator.title = isOnline ? 'Online' : 'Offline';
    }

    function loadSettings() {
      try {
        const saved = localStorage.getItem('buttonOrder');
        const savedRate = localStorage.getItem('exchangeRate');
        const savedCurrency = localStorage.getItem('currencyCode');
        
        if (saved) {
          const parsed = JSON.parse(saved);
          if (parsed && parsed.row1 && parsed.row2 && parsed.row3) {
            buttonOrder = parsed;
          }
        }
        if (savedRate) exchangeRate = parseFloat(savedRate);
        if (savedCurrency) currencyCode = savedCurrency;
      } catch (e) {
        console.error('Load settings error:', e);
      }
    }

    function saveSettings() {
      localStorage.setItem('buttonOrder', JSON.stringify(buttonOrder));
      localStorage.setItem('exchangeRate', exchangeRate.toString());
      localStorage.setItem('currencyCode', currencyCode);
    }

    function formatNumber(num, decimals = 0) {
      if (decimals === 0) return Math.round(num).toLocaleString('en-US');
      return num.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatWithK(num, decimals = 0) {
      const absNum = Math.abs(num);

      // 1,000,000,000 or more: round to 1,000,000 units and add 'm'
      if (absNum >= 1000000000) {
        const mValue = Math.round(num / 1000000);
        return mValue.toLocaleString('en-US') + 'm';
      }
      // 1,000,000 or more: round to 1,000 units and add 'k'
      else if (absNum >= 1000000) {
        const kValue = Math.round(num / 1000);
        return kValue.toLocaleString('en-US') + 'k';
      }
      // 1,000 or more: round to integer
      else if (absNum >= 1000) {
        return Math.round(num).toLocaleString('en-US');
      }
      // Less than 1,000: 2 decimal places
      else {
        return formatNumber(num, 2);
      }
    }

    function formatCurrency(num) {
      return formatWithK(num);
    }


    function convertShoeSize(val) {
      let outputA = '', unitA = '', inputB = '', unitInputB = '', outputB = '', unitB = '';

      // MM input (145-300, 5mm increments)
      if (val >= 145 && val <= 300 && val % 5 === 0) {
        const mm = val;
        const usData = SHOE_SIZES.mmToUs[mm];

        if (usData) {
          // Top right: US Men
          outputA = usData.men || '-';
          unitA = 'US M';
          // Bottom left: US Youth
          inputB = usData.youth || '-';
          unitInputB = 'US Y';
          // Bottom right: US Women
          outputB = usData.women || '-';
          unitB = 'US F';
        }
      }
      // US size input (0.5-13.5)
      else if (val >= 0.5 && val <= 13.5) {
        // Find MM from each category
        let mmMen = findMmFromUsSize(val, 'men');
        let mmWomen = findMmFromUsSize(val, 'women');
        let mmYouth = findMmFromUsSize(val, 'youth');

        // Top right: MM for US Men
        outputA = mmMen || '-';
        unitA = 'mm M';

        // Bottom left: MM for US Youth
        inputB = mmYouth || '-';
        unitInputB = 'mm Y';

        // Bottom right: MM for US Women
        outputB = mmWomen || '-';
        unitB = 'mm F';
      }
      // EU size input (25-48)
      else if (val >= 25 && val <= 48) {
        // Find MM from each category
        let mmMen = findMmFromEuSize(val, 'men');
        let mmWomen = findMmFromEuSize(val, 'women');
        let mmKids = findMmFromEuSize(val, 'kids');

        // Top right: MM for EU Men
        outputA = mmMen || '-';
        unitA = 'mm M';

        // Bottom left: MM for EU Kids
        inputB = mmKids || '-';
        unitInputB = 'mm Y';

        // Bottom right: MM for EU Women
        outputB = mmWomen || '-';
        unitB = 'mm F';
      }

      return { outputA, unitA, inputB, unitInputB, outputB, unitB };
    }

    function convert() {
      let input = document.getElementById('mainInput').value;
      // In $ mode, remove commas before parsing
      if (currentMode === '$') {
        input = input.replace(/,/g, '');
      }
      const val = parseFloat(input) || 0;
      
      let outputA = '', unitA = '', inputB = '', unitInputB = '', outputB = '', unitB = '';

      if (!currentMode || val === 0) {
        document.getElementById('outputA').textContent = '';
        document.getElementById('outputUnitA').textContent = '';
        document.getElementById('inputB').textContent = '';
        document.getElementById('inputUnitB').textContent = '';
        document.getElementById('outputB').textContent = '';
        document.getElementById('outputUnitB').textContent = '';
        return;
      }

      switch(currentMode) {
        case '$/lb':
          const pricePerKg = val * 2.20462262;
          outputA = formatNumber(pricePerKg, 2);
          unitA = '$/kg';
          inputB = input;
          unitInputB = '$/lb';
          const localPricePerKg = pricePerKg * exchangeRate;
          // Show 'k' if 100,000 or more
          if (localPricePerKg >= 100000) {
            outputB = Math.round(localPricePerKg / 1000).toLocaleString('en-US') + 'k';
          } else {
            outputB = Math.round(localPricePerKg).toLocaleString('en-US');
          }
          unitB = `${currencyCode}/kg`;
          break;

        case 'lb.oz':
          const parts = input.split('.');
          const pounds = parseInt(parts[0]) || 0;
          const ounces = parseInt(parts[1]) || 0;
          const totalOz = pounds * 16 + ounces;
          const kg = totalOz * 0.0283495;

          if (kg >= 1) {
            outputA = formatNumber(kg, 2);
            unitA = 'kg';
          } else {
            outputA = formatNumber(kg * 1000);
            unitA = 'g';
          }

          inputB = input;
          unitInputB = 'kg';

          const kgInput = val;
          const totalOzFromKg = kgInput / 0.0283495;
          const lbFromKg = Math.floor(totalOzFromKg / 16);
          const ozFromKg = Math.round(totalOzFromKg % 16);

          outputB = `${lbFromKg} lb ${ozFromKg} oz`;
          unitB = '';
          break;

        case 'lb':
          const kgFromLb = val * 0.45359237;
          if (kgFromLb >= 1) {
            outputA = formatNumber(kgFromLb, 2);
            unitA = 'kg';
          } else {
            outputA = formatNumber(kgFromLb * 1000);
            unitA = 'g';
          }
          inputB = input;
          unitInputB = 'kg';
          outputB = formatNumber(val * 2.20462262, 3);
          unitB = 'lb';
          break;

        case 'F':
          const celsius = (val - 32) * 5 / 9;
          outputA = formatNumber(celsius);
          unitA = '°C';
          inputB = formatNumber(val);
          unitInputB = '°C';
          outputB = formatNumber(val * 9 / 5 + 32);
          unitB = '°F';
          break;

        case 'shoes':
          const shoeResult = convertShoeSize(val);
          outputA = shoeResult.outputA;
          unitA = shoeResult.unitA;
          inputB = shoeResult.inputB;
          unitInputB = shoeResult.unitInputB;
          outputB = shoeResult.outputB;
          unitB = shoeResult.unitB;
          break;

        case 'ft.in':
          const ftInParts = input.split('.');
          const feet = parseInt(ftInParts[0]) || 0;
          const inches = parseInt(ftInParts[1]) || 0;
          const totalInches = feet * 12 + inches;
          const cmFromFtIn = totalInches * 2.54;
          const mFromFtIn = cmFromFtIn / 100;

          if (mFromFtIn >= 1) {
            outputA = formatNumber(mFromFtIn, 2);
            unitA = 'm';
          } else {
            outputA = formatNumber(cmFromFtIn);
            unitA = 'cm';
          }

          inputB = input;
          unitInputB = 'm';

          const metersInput = val;
          const totalInFromM = metersInput * 100 / 2.54;
          const ftFromM = Math.floor(totalInFromM / 12);
          const inFromM = Math.round(totalInFromM % 12);

          outputB = `${ftFromM}' ${inFromM}"`;
          unitB = '';
          break;

        case 'ft':
          const mFromFt = val * 0.3048;
          if (mFromFt >= 1) {
            outputA = formatNumber(mFromFt, 2);
            unitA = 'm';
          } else {
            outputA = formatNumber(mFromFt * 100);
            unitA = 'cm';
          }
          inputB = input;
          unitInputB = 'm';
          outputB = formatNumber(val / 0.3048, 2);
          unitB = 'ft';
          break;

        case '$':
          const localAmount = val * exchangeRate;
          outputA = formatWithK(localAmount);
          unitA = currencyCode;

          // Bottom left: show 'k' if 1,000,000 or more, otherwise thousand separators
          const valForInputB = val;
          if (valForInputB >= 1000000) {
            inputB = Math.round(valForInputB / 1000).toLocaleString('en-US') + 'k';
          } else {
            inputB = valForInputB.toLocaleString('en-US');
          }
          unitInputB = currencyCode;
          const dollarAmount = val / exchangeRate;
          outputB = formatCurrency(dollarAmount);
          unitB = '$';
          break;

        case 'mile':
          const kmFromMile = val * 1.609344;
          if (kmFromMile >= 1) {
            outputA = formatNumber(kmFromMile, 2);
            unitA = 'km';
          } else {
            outputA = formatNumber(kmFromMile * 1000);
            unitA = 'm';
          }
          inputB = input;
          unitInputB = 'km';
          outputB = formatNumber(val / 1.609344, 3);
          unitB = 'mile';
          break;

        case 'mpg':
          outputA = formatNumber(val * 0.425143707, 2);
          unitA = 'km/L';
          inputB = formatNumber(val * 0.425143707, 2);
          unitInputB = 'km/L';
          outputB = formatNumber(val / 0.425143707, 2);
          unitB = 'mpg';
          break;

        case 'gallon':
          outputA = formatNumber(val * 3.785411784, 2);
          unitA = 'liter';
          inputB = input;
          unitInputB = 'liter';
          outputB = formatNumber(val / 3.785411784, 3);
          unitB = 'gallon';
          break;

        case 'yard':
          outputA = formatNumber(val * 0.9144, 2);
          unitA = 'm';
          inputB = input;
          unitInputB = 'm';
          outputB = formatNumber(val / 0.9144, 2);
          unitB = 'yard';
          break;
      }

      document.getElementById('outputA').textContent = outputA;
      document.getElementById('outputUnitA').textContent = unitA;
      document.getElementById('inputB').textContent = inputB;
      document.getElementById('inputUnitB').textContent = unitInputB;
      document.getElementById('outputB').textContent = outputB;
      document.getElementById('outputUnitB').textContent = unitB;
    }

    function renderButtons() {
      const grid = document.getElementById('buttonGrid');
      grid.innerHTML = '';
      
      const rows = [buttonOrder.row1, buttonOrder.row2, buttonOrder.row3];
      
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        if (!row || !Array.isArray(row)) continue;
        
        const rowDiv = document.createElement('div');
        rowDiv.className = 'button-row';
        
        for (let j = 0; j < row.length; j++) {
          const mode = row[j];
          const btn = document.createElement('button');
          btn.className = 'convert-btn';
          btn.textContent = mode;
          if (mode === currentMode) btn.classList.add('active');
          btn.addEventListener('click', () => {
            currentMode = mode;
            document.getElementById('inputUnit').textContent = mode;
            renderButtons();
            convert();
            document.getElementById('mainInput').focus();
          });
          rowDiv.appendChild(btn);
        }
        grid.appendChild(rowDiv);
      }
    }

    function renderSettings(skipExchangeRateUpdate = false) {
      const grid = document.getElementById('settingsGrid');
      grid.innerHTML = '';

      const tempOrder = {
        row1: [...buttonOrder.row1],
        row2: [...buttonOrder.row2],
        row3: [...buttonOrder.row3]
      };

      const rows = [tempOrder.row1, tempOrder.row2, tempOrder.row3];

      for (let rowIdx = 0; rowIdx < rows.length; rowIdx++) {
        const row = rows[rowIdx];
        if (!row) continue;

        const rowDiv = document.createElement('div');
        rowDiv.className = 'settings-row';
        rowDiv.dataset.row = rowIdx;

        for (let idx = 0; idx < row.length; idx++) {
          const mode = row[idx];
          const btn = document.createElement('div');
          btn.className = 'draggable-btn';
          btn.textContent = mode;
          btn.draggable = true;
          btn.dataset.row = rowIdx;
          btn.dataset.idx = idx;

          btn.addEventListener('dragstart', (e) => {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify({row: rowIdx, idx}));
            btn.classList.add('dragging');
          });

          btn.addEventListener('dragend', () => {
            btn.classList.remove('dragging');
          });

          btn.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
          });

          btn.addEventListener('drop', (e) => {
            e.preventDefault();
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const fromRow = data.row;
            const fromIdx = data.idx;
            const toRow = parseInt(btn.dataset.row);
            const toIdx = parseInt(btn.dataset.idx);

            const item = tempOrder[`row${fromRow + 1}`][fromIdx];
            tempOrder[`row${fromRow + 1}`].splice(fromIdx, 1);
            tempOrder[`row${toRow + 1}`].splice(toIdx, 0, item);

            buttonOrder = tempOrder;
            renderSettings();
          });

          rowDiv.appendChild(btn);
        }
        grid.appendChild(rowDiv);
      }

      // If skipExchangeRateUpdate is true, don't touch the exchange rate input field
      if (!skipExchangeRateUpdate) {
        document.getElementById('exchangeRateInput').value = exchangeRate;
        document.getElementById('currencyCode').value = currencyCode;
      } else {
        // Update only currencyCode
        document.getElementById('currencyCode').value = currencyCode;
      }

      const lastCheck = localStorage.getItem('lastUpdateCheck');
      if (lastCheck) {
        const date = new Date(parseInt(lastCheck));
        document.getElementById('lastUpdateCheck').textContent =
          `Last checked: ${date.toLocaleString('en-US')}`;
      }
    }

    async function fetchCurrentExchangeRate() {
      if (!isOnline) {
        alert('You can only fetch exchange rates when online.');
        return;
      }

      const currency = document.getElementById('currencyCode').value.toUpperCase() || 'KRW';
      const btn = document.getElementById('fetchRateBtn');
      btn.textContent = 'Fetching...';
      btn.disabled = true;

      try {
        // Support Japanese Yen KRW/JPY conversion
        let targetCurrency = currency;
        let needsConversion = false;

        // Handle formats like KRW/JPY
        if (currency.includes('/')) {
          const parts = currency.split('/');
          if (parts[0] === 'KRW' && parts[1] === 'JPY') {
            targetCurrency = 'JPY';
            needsConversion = true;
          }
        }

        // Use exchangerate.host API
        const response = await fetch(`https://api.exchangerate.host/latest?base=USD&symbols=${targetCurrency},KRW`);

        if (!response.ok) throw new Error('API response error');

        const data = await response.json();

        if (data.rates) {
          if (needsConversion && data.rates.KRW && data.rates.JPY) {
            // Calculate KRW/JPY
            const rate = data.rates.KRW / data.rates.JPY;
            document.getElementById('exchangeRateInput').value = rate.toFixed(2);
            document.getElementById('currencyCode').value = 'KRW';
            alert(`Current rate: 1 KRW = ${(1/rate).toFixed(4)} JPY\n(or 100 JPY = ${(100/rate).toFixed(2)} KRW)`);
          } else if (data.rates[targetCurrency]) {
            const rate = data.rates[targetCurrency];
            document.getElementById('exchangeRateInput').value = rate.toFixed(2);
            alert(`Current rate: 1 USD = ${rate.toFixed(2)} ${targetCurrency}`);
          } else {
            throw new Error('No exchange rate data');
          }
        } else {
          throw new Error('No exchange rate data');
        }
      } catch (error) {
        console.error('Failed to fetch exchange rate:', error);
        // Fallback: try alternative API
        try {
          const response2 = await fetch(`https://open.er-api.com/v6/latest/USD`);
          const data2 = await response2.json();
          let targetCurrency = currency;
          
          if (currency.includes('/')) {
            const parts = currency.split('/');
            if (parts[0] === 'KRW' && parts[1] === 'JPY') {
              if (data2.rates && data2.rates.KRW && data2.rates.JPY) {
                const rate = data2.rates.KRW / data2.rates.JPY;
                document.getElementById('exchangeRateInput').value = rate.toFixed(2);
                document.getElementById('currencyCode').value = 'KRW';
                alert(`Current rate: 1 KRW = ${(1/rate).toFixed(4)} JPY\n(or 100 JPY = ${(100/rate).toFixed(2)} KRW)`);
                return;
              }
            }
            targetCurrency = parts[0];
          }

          if (data2.rates && data2.rates[targetCurrency]) {
            const rate = data2.rates[targetCurrency];
            document.getElementById('exchangeRateInput').value = rate.toFixed(2);
            alert(`Current rate: 1 USD = ${rate.toFixed(2)} ${targetCurrency}`);
          } else {
            alert(`Cannot find exchange rate for ${currency}.`);
          }
        } catch (error2) {
          alert('Failed to fetch exchange rate. Please check your internet connection.');
        }
      } finally {
        btn.textContent = 'Current Rate';
        btn.disabled = false;
      }
    }

    async function checkForUpdates() {
      if (!isOnline) return;
      try {
        const response = await fetch('./version.json?' + Date.now(), { cache: 'no-store' });
        if (!response.ok) return;
        const versionData = await response.json();
        localStorage.setItem('lastUpdateCheck', Date.now().toString());
        if (versionData.version !== APP_VERSION) {
          showUpdateBanner();
        }
      } catch (error) {
        // Ignore errors
      }
    }

    function showUpdateBanner() {
      const banner = document.getElementById('updateBanner');
      if (localStorage.getItem('updateDismissed') !== 'true') {
        banner.classList.add('show');
      }
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (window.matchMedia('(display-mode: standalone)').matches || 
          localStorage.getItem('installDismissed') === 'true') {
        return;
      }
      setTimeout(() => {
        document.getElementById('installBanner').classList.add('show');
      }, 3000);
    });

    document.getElementById('mainInput').addEventListener('input', (e) => {
      let val = e.target.value;

      // Apply comma format only in $ mode
      if (currentMode === '$') {
        // Remove commas and extract numbers only
        let numericValue = val.replace(/,/g, '');

        // Allow only numbers and decimal point
        if (!/^-?\d*\.?\d*$/.test(numericValue)) {
          e.target.value = val.slice(0, -1);
          return;
        }

        // Don't apply formatting if there's a decimal point
        if (numericValue.includes('.')) {
          e.target.value = numericValue;
        } else if (numericValue !== '') {
          // Add commas only for integers
          const formatted = parseFloat(numericValue).toLocaleString('en-US');
          e.target.value = formatted;
        }

        convert();
      } else {
        // Keep existing logic for other modes
        if (!/^-?\d*\.?\d*$/.test(val)) {
          e.target.value = val.slice(0, -1);
          return;
        }
        convert();
      }
    });

    document.getElementById('clearBtn').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('mainInput').value = '';
      currentMode = null;
      document.getElementById('inputUnit').textContent = '';
      renderButtons();
      convert();
      document.getElementById('mainInput').focus();
    });

    document.getElementById('settingsBtn').addEventListener('click', () => {
      document.getElementById('settingsScreen').classList.add('active');
      renderSettings();
    });

    document.getElementById('cancelBtn').addEventListener('click', () => {
      loadSettings();
      document.getElementById('settingsScreen').classList.remove('active');
      renderButtons();
    });

    document.getElementById('defaultBtn').addEventListener('click', async () => {
      buttonOrder = {
        row1: ['$/lb', 'lb.oz', 'lb', 'F'],
        row2: ['shoes', 'ft.in', 'ft', '$'],
        row3: ['mile', 'mpg', 'gallon', 'yard']
      };

      // Set currency code first (fetchCurrentExchangeRate reads this value)
      currencyCode = DEFAULT_CURRENCY;
      document.getElementById('currencyCode').value = DEFAULT_CURRENCY;

      // Act as if current rate button was clicked
      if (isOnline) {
        await fetchCurrentExchangeRate();
        // fetchCurrentExchangeRate() updates the input field

        // Re-render entire settings, but don't overwrite exchange rate input
        renderSettings(true);
      } else {
        // Use default value if offline
        document.getElementById('exchangeRateInput').value = DEFAULT_RATE;
        renderSettings(true);
      }
    });

    document.getElementById('saveBtn').addEventListener('click', () => {
      exchangeRate = parseFloat(document.getElementById('exchangeRateInput').value) || DEFAULT_RATE;
      currencyCode = document.getElementById('currencyCode').value.toUpperCase() || DEFAULT_CURRENCY;
      saveSettings();
      document.getElementById('settingsScreen').classList.remove('active');
      renderButtons();
      convert();
    });

    document.getElementById('fetchRateBtn').addEventListener('click', fetchCurrentExchangeRate);

    document.getElementById('updateNow').addEventListener('click', () => {
      window.location.reload(true);
    });

    document.getElementById('dismissUpdate').addEventListener('click', () => {
      document.getElementById('updateBanner').classList.remove('show');
      localStorage.setItem('updateDismissed', 'true');
    });

    document.getElementById('installApp').addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      deferredPrompt = null;
      document.getElementById('installBanner').classList.remove('show');
    });

    document.getElementById('dismissInstall').addEventListener('click', () => {
      document.getElementById('installBanner').classList.remove('show');
      localStorage.setItem('installDismissed', 'true');
    });

    window.addEventListener('online', () => {
      updateOnlineStatus();
      checkForUpdates();
    });

    window.addEventListener('offline', updateOnlineStatus);

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('SW registered'))
        .catch(() => console.log('SW not available'));
    }

    loadSettings();
    renderButtons();
    updateOnlineStatus();
    if (isOnline) checkForUpdates();
    document.getElementById('mainInput').focus();
  </script>
</body>
</html>
